<!DOCTYPE html>
<html>
<head>
	<title>Template compiler tests</title>
	<script type="text/javascript" src="../../../yui.3.5.0/build/yui/yui-min.js"></script>
	<script type="text/javascript" src="../../../yui.3.5.0/build/loader/loader.js"></script>
	<script type="text/javascript" src="../../build/supra/supra.js"></script>
	<script type="text/javascript" src="../../build/supra/data.js"></script>
	<script type="text/javascript" src="../../build/supra/modules.js"></script>
</head>
<body class="yui3-skin-supra">

	<script type="text/javascript">
	//<![CDATA[
	
		Supra('console', 'test', 'dump', function (Y) {
			
			// Set up the page
	        var ASSERT = Y.Assert;
	       	
	        var testBasic = new Y.Test.Case({
	            name: 'Template compiler',
	            
	            testVariables: function () {
	            	
	            	var fn = Supra.Template.compile('{{ data[\'bar\'] }} {{ data.foo }} {{ data["zoo"] }}');
	            	var out = fn({'data': {'bar': 'Bar', 'foo': 'Foo', 'zoo': 'Zoo'}});
	            	
	            	ASSERT.areEqual('Bar Foo Zoo', out, 'Access variables');
	            	
	            },
	            
	            testUndefinedVariables: function () {
	            	
	            	var fn = Supra.Template.compile('{{ data[\'bar\'] }} {{ data.foo }} {{ data["zoo"] }} {{ data["pet"]}} ');
	            	var out = fn({'data': {'bar': 'Bar', 'zoo': 'Zoo'}});
	            	
	            	ASSERT.areEqual('Bar  Zoo  ', out, 'Access undefined or null variables');
	            	
	            },
	            
	            testIfNegation: function () {
	            	
	            	var fn = Supra.Template.compile('{% if !data %}No data{% else %}Has data{% endif %}');
	            	var out = fn({'data': true});
	            	
	            	ASSERT.areEqual('Has data', out, 'if');
	            	
	            },
	            
	            testExpressionInIf: function () {
	            	
	            	var fn = Supra.Template.compile('{% if data[index+1] %}Ok{% endif %}');
	            	var out = fn({'data': ['a', 'b', 'c', 'd'], 'index': 2});
	            	
	            	ASSERT.areEqual('Ok', out, 'Expression in if');
	            	
	            },
	            
	            testExpression: function () {
	            	var fn = Supra.Template.compile('{% if (x-y)%z==1 %}Ok{% endif %}');
	            	var out = fn({'x': 10, 'y': 3, 'z': 2});
	            	
	            	ASSERT.areEqual('Ok', out, 'Complex expressions without whitespaces');
	            	
	            	var fn = Supra.Template.compile('{% if ( x - y ) % z == 1 %}Ok{% endif %}');
	            	var out = fn({'x': 10, 'y': 3, 'z': 2});
	            	
	            	ASSERT.areEqual('Ok', out, 'Complex expressions with whitespaces');
	            	
	            	var fn = Supra.Template.compile('{% if itemA and itemB or !itemC %}Ok{% endif %}');
	            	var out = fn({'itemA': true, 'itemB': false, 'itemC': false});
	            	
	            	ASSERT.areEqual('Ok', out, 'and, or expressions');
	            },
	            
	            testLoopItem: function () {
	            	
	            	var fn = Supra.Template.compile('{% for item in data %}{{ item }}{% endfor %}');
	            	var out = fn({'data': ['a', 'b', 'c', 'd']});
	            	
	            	ASSERT.areEqual('abcd', out, 'Loop');
	            	
	            },
	            
	            testLoopUndefined: function () {
	            	
	            	var fn = Supra.Template.compile('Un{% for item in data %}{{ item }}{% endfor %}defined');
	            	var out = fn({});
	            	
	            	ASSERT.areEqual('Undefined', out, 'Loop undefined');
	            	
	            },
	            
	            testLoopNull: function () {
	            	
	            	var fn = Supra.Template.compile('Nu{% for item in data %}{{ item }}{% endfor %}ll');
	            	var out = fn({'data': null});
	            	
	            	ASSERT.areEqual('Null', out, 'Loop undefined');
	            	
	            },
	            
	            testLoopItemFirstLast: function () {
	            	
	            	var fn = Supra.Template.compile('{% for item in data %}{% if !loop.first && !loop.last %}{{ item }}{% endif %}{% endfor %}');
	            	var out = fn({'data': ['a', 'b', 'c', 'd']});
	            	
	            	ASSERT.areEqual('bc', out, 'First or last index not found');
	            	
	            },
	            
	            testSet: function () {
	            	
	            	var fn = Supra.Template.compile('{% set x = 10 %}{{ x + 1 }}');
	            	var out = fn({});
	            	
	            	ASSERT.areEqual('11', out, 'Set not correct');
	            	
	            },
	            
	            testRange: function () {
	            	
	            	var fn = Supra.Template.compile('{{ range(1,5) }}');
	            	var out = fn({});
	            	
	            	ASSERT.areEqual('1,2,3,4,5', out, 'Range function output not correct');
	            	
	            },
	            
	            testFilters: function () {
	            	
	            	var fn = Supra.Template.compile('{{ text|title }}');
	            	ASSERT.areEqual('This Is A Text', fn({'text': 'this is a text'}), 'Title filter');
	            	
	            	var fn = Supra.Template.compile('{{ text|striptags }}');
	            	ASSERT.areEqual('this is a text', fn({'text': '<i>this <b>is</b> a text'}), 'Strip tags filter');
	            	
	            	var fn = Supra.Template.compile('{{ data[key]|upper }}');
	            	ASSERT.areEqual('TEXT', fn({'data': {'a': 'text'}, 'key': 'a'}), 'Test complex expression');
	            	
	            	var fn = Supra.Template.compile('{{ data[key]|default("q") }}');
	            	ASSERT.areEqual('q', fn({'data': {'a': ''}, 'key': 'a'}), 'Test default filter');
	            	
	            	var fn = Supra.Template.compile('{{ data[key]|default("q") }}');
	            	ASSERT.areNotEqual('q', fn({'data': {'a': 'b'}, 'key': 'a'}), 'Test default filter failure');
	            	
	            	var fn = Supra.Template.compile('{{ data|reverse|join("-") }}');
	            	ASSERT.areEqual('4-3-2-1', fn({'data': [1,2,3,4]}), 'Multiple filters');
	            	
	            	var fn = Supra.Template.compile('{{ data|escape }}');
	            	ASSERT.areEqual('a&lt;b&gt;c&amp;d', fn({'data': 'a<b>c&d'}), 'Escape filter');
	            	
	            	var fn = Supra.Template.compile('{{ text|replace({ "Aaa Bbb": "Ccc Ddd" })|escape }}');
	            	ASSERT.areEqual('Name: Ccc Ddd', fn({'text': 'Name: Aaa Bbb'}), 'Filters with complex parameters');
	            }
	            
	            
			});
			
			var console = new Y.Console({'height': '92%', 'width': '70%'}).render();
			
	        Y.Test.Runner.add(testBasic);
	        Y.Test.Runner.run();
		});
		
	//]]>
	</script>
	
</body>
</html>
